Bootstrap: docker
From: debian:bullseye

%files
    /usr/bin/kmc /kmc/kmc
    /usr/bin/kmc_tools /kmc/kmc_tools

    #visualiser.py /thesis/visualiser.py
    src /thesis/src
    tests /thesis/tests
    include /thesis/include

    submodules /thesis/submodules

    data/benchmarking/ thesis/data/

    CMakeLists.txt /thesis/CMakeLists.txt

    requirements_apptainer.txt /thesis/requirements.txt
    bench.py /thesis/bench.py
    benchmarking.py /thesis/benchmarking.py
    ./data/small_test /thesis/data/small_test
    ./tmp /thesis/tmp
    .git/refs/heads/main /thesis/current_commit.txt

%post -c /bin/bash
    apt-get update -y && apt-get install -y cmake build-essential g++ git gcc libtbb-dev libgomp1 libboost-all-dev libhdf5-serial-dev libeigen3-dev
    echo 'deb http://deb.debian.org/debian testing main' >> /etc/apt/sources.list
    apt-get update -y && apt-get upgrade -y
    apt-get install -y linux-perf python3-pip

    cd thesis/submodules/unordered_dense/build
    cmake ..
    cmake --build . --target install

    mkdir -p /thesis/build
    cd /thesis/build/

    mkdir -p /thesis/build/fasta /thesis/build/tmp /thesis/build/results

    cmake -DCMAKE_BUILD_TYPE=Release -DCountVLMC_COMPILE_TESTS=OFF ..
    make -j 8

    #cp ../visualiser.py .

    cp /kmc/kmc .
    cp /kmc/kmc_tools .

    cd ..
    cd ..
    pip install virtualenv
    mkdir /venv
    virtualenv /venv/kmers_env
    source /venv/kmers_env/bin/activate
    pip install -r /thesis/requirements.txt
    #export PATH=/root/.local/bin:$PATH

%environment
    export PATH="/thesis/build/:$PATH"

%test
    #cd /thesis/build/tests
    #echo "Running tests"
	#./kmer_tests

%apprun benchmark
    . /venv/kmers_env/bin/activate
    cd /thesis
    python3 benchmarking.py benchmark $*

%apprun parabench
    . /venv/kmers_env/bin/activate
    cd /thesis
    python3 benchmarking.py parabench $*

%apprun sizebenchmark
    . /venv/kmers_env/bin/activate
    cd /thesis
    python3 benchmarking.py sizebenchmark $*